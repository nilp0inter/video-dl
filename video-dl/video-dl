#!/bin/sh
set -ex
mkdir -p /downloads /logs
kapow route add -X POST    '/download' -e /video-dl/download-video
kapow route add -X DELETE  '/download/{pid:[a-f0-9\-]+}' -e /video-dl/delete-download
kapow route add -X OPTIONS  '/{url:.*}' - <<'EOF'
	set -x
	kapow set /response/headers/Access-Control-Allow-Origin "$(kapow get /request/headers/Origin)"
	kapow set /response/headers/Access-Control-Allow-Methods "GET, OPTIONS, DELETE"
	kapow set /response/status 204
EOF

kapow route add -X GET     '/download/{pid:[a-f0-9\-]+}/status' -e /video-dl/get-download-status

kapow route add -X GET     '/download/{pid:[a-f0-9\-]+}/log/{stream:submitted|stdout|stderr}' -e /video-dl/get-download-log -c 'text/plain'
kapow route add -X GET     '/download/{pid:[a-f0-9\-]+}/log/{stream:pending|done|error}' -e /video-dl/get-download-log -c 'application/json'

